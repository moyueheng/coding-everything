# Kimi Skills 架构全景图

本文档详细描述 `coding-everything` 项目中 Kimi Skills 的架构关系、调用流程和核心原则。

---

## 目录

- [架构分层图](#架构分层图)
- [Skill 调用关系与数据流](#skill-调用关系与数据流)
- [核心原则与反模式](#核心原则与反模式)
- [状态机与决策树](#状态机与决策树)
- [Skill 清单](#skill-清单)

---

## 架构分层图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         KIMI SKILLS 全景架构图                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  第零层: 入口与规则 (Meta Layer)                                     │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │                    dev-using-skills                         │    │   │
│   │  │  ┌─────────────────────────────────────────────────────────┐│    │   │
│   │  │  │  铁律: 1%可能适用就必须调用 │ 先调用skill再响应         ││    │   │
│   │  │  │  优先级: 流程skills > 实现skills │ 严格型vs灵活型        ││    │   │
│   │  │  │  红旗: "太简单不需要" "先看一下" "我记得这个skill"        ││    │   │
│   │  │  └─────────────────────────────────────────────────────────┘│    │   │
│   │  │  类型: 严格型 │ 触发: 每次对话开始时                          │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  第一层: 设计阶段 (Design Phase)                                     │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │                   dev-brainstorming                         │    │   │
│   │  │  ┌─────────────────────────────────────────────────────────┐│    │   │
│   │  │  │  流程: 探索上下文 → 澄清问题 → 2-3方案 → 展示设计        ││    │   │
│   │  │  │  HARD-GATE: 未获用户批准禁止编写代码                     ││    │   │
│   │  │  │  输出: docs/plans/YYYY-MM-DD-<topic>-design.md           ││    │   │
│   │  │  └─────────────────────────────────────────────────────────┘│    │   │
│   │  │  类型: 严格型 │ 下一步: dev-writing-plans                     │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  第二层: 计划阶段 (Planning Phase)                                   │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │                    dev-writing-plans                        │    │   │
│   │  │  ┌─────────────────────────────────────────────────────────┐│    │   │
│   │  │  │  粒度: 2-5分钟/任务 │ 每个任务必须引用 dev-tdd          ││    │   │
│   │  │  │  内容: 精确路径 + 完整代码 + 预期输出 + 提交命令         ││    │   │
│   │  │  │  原则: DRY │ YAGNI │ TDD │ 频繁提交                      ││    │   │
│   │  │  └─────────────────────────────────────────────────────────┘│    │   │
│   │  │  类型: 严格型 │ 输出: docs/plans/YYYY-MM-DD-<feature>.md      │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  第三层: 执行阶段 (Execution Phase)                                  │   │
│   │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐   │   │
│   │  │dev-git-worktrees│  │dev-executing-   │  │   dev-requesting-   │   │   │
│   │  │                 │  │    plans        │  │      review         │   │   │
│   │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │  ┌─────────────┐    │   │   │
│   │  │ │隔离工作区   │ │  │ │批量执行     │ │  │  │ 代码审查    │    │   │   │
│   │  │ │.worktrees/  │ │  │ │3任务/批次   │ │  │  │ 子agent驱动 │    │   │   │
│   │  │ │验证.gitignore│ │  │ │调用dev-tdd  │ │  │  │ 每任务后    │    │   │   │
│   │  │ │运行项目设置 │ │  │ │批次间汇报   │ │  │  │ 每批次后    │    │   │   │
│   │  │ │验证干净基线 │ │  │ │阻塞时停止   │ │  │  └─────────────┘    │   │   │
│   │  │ └─────────────┘ │  │ └─────────────┘ │  │                     │   │   │
│   │  │ 类型: 严格型    │  │ 类型: 严格型    │  │  类型: 严格型       │   │   │
│   │  └─────────────────┘  └────────┬────────┘  └─────────────────────┘   │   │
│   │                                │                                      │   │
│   │           ┌────────────────────┼────────────────────┐                 │   │
│   │           ▼                    ▼                    ▼                 │   │
│   │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐       │   │
│   │  │     dev-tdd     │  │  dev-debugging  │  │ dev-verification│       │   │
│   │  │  ┌───────────┐  │  │  ┌───────────┐  │  │  ┌───────────┐  │       │   │
│   │  │  │ 红: 失败  │  │  │  │阶段1: 根本│  │  │  │ 门控函数  │  │       │   │
│   │  │  │ 验证红    │  │  │  │阶段2: 模式│  │  │  │ 识别→运行 │  │       │   │
│   │  │  │ 绿: 通过  │  │  │  │阶段3: 假设│  │  │  │ 阅读→验证 │  │       │   │
│   │  │  │ 验证绿    │  │  │  │阶段4: TDD │  │  │  │ →声称     │  │       │   │
│   │  │  │ 重构: 清理│  │  │  │3+失败→架构│  │  │  │           │  │       │   │
│   │  │  └───────────┘  │  │  └───────────┘  │  │  └───────────┘  │       │   │
│   │  │ 类型: 严格型    │  │  类型: 严格型    │  │  类型: 严格型    │       │   │
│   │  └─────────────────┘  └─────────────────┘  └─────────────────┘       │   │
│   │                                │                                      │   │
│   └────────────────────────────────┼──────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  第四层: 完成阶段 (Completion Phase)                                 │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │                  dev-finishing-branch                       │    │   │
│   │  │  ┌─────────────────────────────────────────────────────────┐│    │   │
│   │  │  │ 步骤1: 验证测试通过                                      ││    │   │
│   │  │  │ 步骤2: 展示4选项 → 1.本地合并 2.创建PR 3.保持 4.丢弃    ││    │   │
│   │  │  │ 步骤3: 执行选择                                          ││    │   │
│   │  │  │ 步骤4: 清理worktree(选项1,2,4)                          ││    │   │
│   │  │  └─────────────────────────────────────────────────────────┘│    │   │
│   │  │  类型: 严格型 │ 调用方: dev-executing-plans, subagent驱动     │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  第五层: 领域实现层 (Domain Implementation)                          │   │
│   │  ═══════════════════════════════════════════                        │   │
│   │                                                                     │   │
│   │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐  │   │
│   │  │dev-backend-     │  │dev-frontend-    │  │   dev-code-cleanup  │  │   │
│   │  │   patterns      │  │   patterns      │  │                     │  │   │
│   │  │ ┌─────────────┐ │  │ ┌─────────────┐ │  │  ┌─────────────┐    │  │   │
│   │  │ │FastAPI      │ │  │ │React/TS     │ │  │  │ 工具检测    │    │  │   │
│   │  │ │Repository   │ │  │ │组合模式     │ │  │  │ 风险分级    │    │  │   │
│   │  │ │Service层    │ │  │ │Hooks        │ │  │  │ 测试验证    │    │  │   │
│   │  │ │N+1预防      │ │  │ │状态管理     │ │  │  │ 安全删除    │    │  │   │
│   │  │ │Redis缓存    │ │  │ │性能优化     │ │  │  │ SAFE/CAUTION│    │  │   │
│   │  │ │JWT/RBAC     │ │  │ │表单/动画    │ │  │  │ /DANGER     │    │  │   │
│   │  │ │限流/队列    │ │  │ │无障碍       │ │  │  └─────────────┘    │  │   │
│   │  │ └─────────────┘ │  │ └─────────────┘ │  │  类型: 灵活型       │  │   │
│   │  │ 类型: 灵活型    │  │ 类型: 灵活型    │  └─────────────────────┘  │   │
│   │  └─────────────────┘  └─────────────────┘                           │   │
│   │                                                                     │   │
│   │  ┌─────────────────┐  ┌─────────────────────────────────────────┐   │   │
│   │  │dev-update-      │  │         dev-writing-skills              │   │   │
│   │  │   codemaps      │  │  ┌─────────────────────────────────┐    │   │   │
│   │  │                 │  │  │ 元skill: 编写skill的skill       │    │   │   │
│   │  │ ┌─────────────┐ │  │  │                                 │    │   │   │
│   │  │ │扫描结构     │ │  │  │ 红: 压力场景测试(看agent失败)   │    │   │   │
│   │  │ │生成codemaps │ │  │  │ 绿: 编写解决特定违规的skill     │    │   │   │
│   │  │ │差异检测>30% │ │  │  │ 重构: 关闭漏洞,合理化表,红旗   │    │   │   │
│   │  │ │架构文档     │ │  │  │ CSO: 搜索优化(description≠what)│    │   │   │
│   │  │ └─────────────┘ │  │  └─────────────────────────────────┘    │   │   │
│   │  │ 类型: 灵活型    │  │  类型: 严格型(但创建的是灵活型skill)    │   │   │
│   │  └─────────────────┘  └─────────────────────────────────────────┘   │   │
│   │                                                                     │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  基础设施层: 配置安装                                                │   │
│   │  ┌─────────────────────────────────────────────────────────────┐    │   │
│   │  │                         setup                               │    │   │
│   │  │  • 安装 skills 到 ~/.agents/skills/                          │    │   │
│   │  │  • 安装 agent 配置到 ~/.kimi/agents/superpower/              │    │   │
│   │  │  • symlink 模式实现实时同步                                    │    │   │
│   │  │  • 兼容: Kimi CLI, Codex, OpenCode                            │    │   │
│   │  └─────────────────────────────────────────────────────────────┘    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Skill 调用关系与数据流

### 典型开发工作流 (Happy Path)

```
       ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
       │  用户需求 │────►│brainstorm│────►│ writing- │────►│executing-│
       │  "做XX"  │     │  -ing    │     │  plans   │     │  plans   │
       └──────────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
                             │                │                │
                             ▼                ▼                ▼
                        ┌─────────────────────────────────────────┐
                        │      设计文档 + 实施计划文档             │
                        │  docs/plans/YYYY-MM-DD-*.md              │
                        └─────────────────────────────────────────┘
                                          │
                                          ▼
                        ┌─────────────────────────────────────────┐
                        │  循环: 批量执行任务 (默认3个/批)         │
                        │  • 调用 dev-tdd (涉及代码时)             │
                        │  • 调用 dev-requesting-review (批次后)   │
                        │  • 汇报 → 反馈 → 下一批                  │
                        └─────────────────────────────────────────┘
                                          │
                                          ▼
                               ┌─────────────────┐
                               │finishing-branch │
                               │  展示4选项       │
                               │  执行 + 清理    │
                               └─────────────────┘
```

### 调试工作流 (Debug Path)

```
       ┌──────────┐     ┌─────────────────────────────────────────┐
       │  Bug报告 │────►│          dev-debugging                  │
       │ 测试失败 │     │  ┌─────────────────────────────────────┐ │
       └──────────┘     │  │ 阶段1: 根本原因调查                 │ │
                        │  │ • 阅读错误消息 • 一致重现            │ │
                        │  │ • 检查最近变更 • 追踪数据流          │ │
                        │  ├─────────────────────────────────────┤ │
                        │  │ 阶段2: 模式分析                     │ │
                        │  │ • 找到工作示例 • 识别差异            │ │
                        │  ├─────────────────────────────────────┤ │
                        │  │ 阶段3: 假设和测试                   │ │
                        │  │ • 形成单一假设 • 最小测试            │ │
                        │  ├─────────────────────────────────────┤ │
                        │  │ 阶段4: 实现 (必须调用 dev-tdd)      │ │
                        │  │ • RED: 编写失败测试                  │ │
                        │  │ • GREEN: 最小修复                    │ │
                        │  │ • REFACTOR: 清理                     │ │
                        │  └─────────────────────────────────────┘ │
                        └─────────────────────────────────────────┘
                                             │
                                             ▼
                                  ┌─────────────────┐
                                  │ dev-verification│ ◄── 所有完成声称前
                                  │   验证后才声称   │     必经之门
                                  └─────────────────┘
```

### TDD 核心循环 (被多个 skills 调用)

```
       ┌─────────────────────────────────────────────────────────────────┐
       │                         dev-tdd                                │
       │  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐         │
       │  │   RED   │──►│验证RED  │──►│  GREEN  │──►│验证GREEN│         │
       │  │写失败测试│   │看它失败 │   │最小代码 │   │看它通过 │         │
       │  └────┬────┘   └────┬────┘   └────┬────┘   └────┬────┘         │
       │       │             │ 失败原因不对 │             │               │
       │       │             └─────────────┘             │               │
       │       │                                         │               │
       │       │             ┌─────────┐                 │               │
       │       └────────────►│ REFACTOR│◄────────────────┘               │
       │                     │ 清理代码 │                                 │
       │                     │保持绿色  │                                 │
       │                     └────┬────┘                                 │
       │                          │                                      │
       └──────────────────────────┼──────────────────────────────────────┘
                                  │
                                  ▼
                            ┌──────────┐
                            │  下一个  │
                            │  RED测试 │
                            └──────────┘
```

---

## 核心原则与反模式

### 严格型 Skills 铁律

| Skill | 铁律 (不可违反) |
|-------|----------------|
| `dev-using-skills` | "1%可能适用就必须调用"<br>禁止: "简单问题不需要skill" "先看一下代码" |
| `dev-brainstorming` | HARD-GATE: 未获批准禁止编写代码<br>终止状态: 只能调用 dev-writing-plans |
| `dev-tdd` | "没有先有失败的测试,就没有生产代码"<br>禁止: 保留代码"参考" "稍后补测试" 适配测试 |
| `dev-debugging` | "没有先完成第一阶段,就没有修复"<br>3+修复失败 → 必须质疑架构,不继续瞎试 |
| `dev-writing-plans` | 每个实现任务必须引用 dev-tdd<br>粒度: 2-5分钟/任务 |
| `dev-verification` | "没有新鲜验证证据,就没有完成声称"<br>禁止: "应该有效" "看起来正确" "我有信心" |

### 灵活型 Skills 核心原则

| Skill | 核心原则 |
|-------|----------|
| `dev-backend-patterns` | Repository + Service 分层 \| 依赖注入<br>N+1预防 \| 异步优先 \| 类型安全 |
| `dev-frontend-patterns` | 组合优于继承 \| Hooks复用 \| 性能有意识<br>受控组件 \| 错误边界 \| 无障碍优先 |
| `dev-code-cleanup` | 工具检测 → 风险分级 → 测试验证 → 安全删除<br>一次只删一项 \| 不确定就跳过 |
| `dev-update-codemaps` | Token-lean \| 高层结构 > 实现细节<br>差异>30%需批准 \| 新鲜度标头 |
| `dev-writing-skills` | 将 TDD 应用于文档: 红(压力测试) → 绿 → 重构<br>CSO: 描述=何时用(不是做什么) |

### 常见反模式 (禁止)

| 反模式 | 正确做法 |
|--------|----------|
| ❌ "这个太简单了,不需要走流程" | ✅ 简单项目正是假设最多的地方，必须走流程 |
| ❌ "我先看一下代码再调用skill" | ✅ 检查skill优先于探索代码 |
| ❌ "我快速修复一下" | ✅ 快速修复=返工+新bug，遵循调试流程 |
| ❌ "稍后写测试来验证" | ✅ 稍后写的测试立即通过,证明不了什么 |
| ❌ "就这一次跳过TDD" | ✅ 没有例外，必须先写测试 |
| ❌ "代码先写好了,我适配一下测试" | ✅ 删除代码,用TDD重新开始 |
| ❌ "我觉得应该有效" | ✅ 信心≠证据,必须运行验证 |
| ❌ "Agent说成功了" | ✅ 独立验证,检查diff |
| ❌ "这次不同因为..." | ✅ 精神高于文字,规则没有例外 |

---

## 状态机与决策树

### 用户输入分类与 Skill 选择

```
                    ┌──────────────┐
                    │  收到用户消息 │
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
                    │ 调用相关skill │ ◄── dev-using-skills 要求
                    │  即使1%可能   │
                    └──────┬───────┘
                           │
                           ▼
              ┌────────────────────────┐
              │    用户想要什么？       │
              └───────┬────────────────┘
                      │
         ┌────────────┼────────────┬────────────┐
         ▼            ▼            ▼            ▼
    ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
    │ 新功能  │  │ 修Bug   │  │ 代码清理│  │ 其他任务│
    │ "构建X" │  │ "修复Y" │  │ "清理"  │  │ ...     │
    └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘
         │            │            │            │
         ▼            ▼            ▼            ▼
   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
   │brainstorm│  │debugging │  │code-cleanup│ │select    │
   │ -ing     │  │          │  │          │  │appropriate│
   │设计阶段  │  │调试阶段  │  │清理阶段  │  │skill     │
   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
        │             │             │             │
        ▼             ▼             ▼             ▼
   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐
   │writing-  │  │   tdd    │  │verification│ │...       │
   │  plans   │  │(阶段4)   │  │(清理后)   │  │          │
   │计划阶段  │  │修复+测试 │  │验证结果  │  │          │
   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘
        │             │             │             │
        ▼             ▼             ▼             ▼
   ┌────────────────────────────────────────────────────┐
   │           dev-verification (验证后才声称)           │
   └────────────────────────────────────────────────────┘
```

### Skill 优先级决策树

```
              ┌─────────────────────┐
              │ 多个skill可能适用？  │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │ 流程skills优先       │ ◄── 决定 HOW 处理任务
              │ (brainstorm/debug)  │
              └──────────┬──────────┘
                         │
                         ▼
              ┌─────────────────────┐
              │ 实现skills其次       │ ◄── 决定具体执行
              │ (patterns/cleanup)  │
              └─────────────────────┘
```

---

## Skill 清单

### 流程型 Skills (严格型)

| Skill 名称 | 触发场景 | 核心输出 | 下一步 |
|-----------|----------|----------|--------|
| `dev-using-skills` | 每次对话开始 | 确定适用的 skill | 根据场景调用相应 skill |
| `dev-brainstorming` | 新功能需求 | 设计文档 | `dev-writing-plans` |
| `dev-writing-plans` | 需要实施计划 | 计划文档 | `dev-executing-plans` |
| `dev-executing-plans` | 有书面计划 | 实现代码 | `dev-finishing-branch` |
| `dev-tdd` | 写代码时 | 测试+实现 | 下一个测试或验证 |
| `dev-debugging` | 遇到 Bug | 修复方案 | `dev-tdd` (阶段4) |
| `dev-verification` | 声称完成前 | 验证报告 | 继续或修复 |
| `dev-requesting-review` | 任务/批次后 | 审查报告 | 修复问题或继续 |
| `dev-finishing-branch` | 开发完成 | 合并/PR/清理 | - |
| `dev-git-worktrees` | 需要隔离工作区 | 干净 worktree | 开发任务 |

### 实现型 Skills (灵活型)

| Skill 名称 | 用途 | 技术栈 |
|-----------|------|--------|
| `dev-backend-patterns` | 后端架构模式 | Python, FastAPI, SQLAlchemy, Redis |
| `dev-frontend-patterns` | 前端架构模式 | React, TypeScript, Next.js |
| `dev-code-cleanup` | 清理死代码 | knip, depcheck, vulture |
| `dev-update-codemaps` | 更新架构文档 | 代码分析, Token-lean |
| `dev-writing-skills` | 编写新 skill | TDD for Documentation |

---

## 总结：核心设计思想

| 设计原则 | 说明 |
|---------|------|
| **分层架构** | 入口层 → 设计层 → 计划层 → 执行层 → 完成层 → 领域层 |
| **严格型/灵活型区分** | 流程类必须严格遵循，实现类可根据上下文调整 |
| **TDD 贯穿始终** | 代码开发用 TDD，编写 skill 本身也用 TDD |
| **验证门控** | dev-verification 是所有完成声称前的必经之门 |
| **技能即代码** | skills 是可版本控制、可测试、可迭代的代码资产 |
| **元能力** | dev-writing-skills 让系统能自我扩展、自我改进 |

---

*文档生成时间: 2026-02-28*
*对应技能版本: kimi/skills v1.0*
